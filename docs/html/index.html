<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MCP79410RK: MCP79410RK</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MCP79410RK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MCP79410RK </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><em>Particle library for <a class="el" href="class_m_c_p79410.html" title="Class for managing the MCP79410 real-time clock chip with SRAM and EEPROM. ">MCP79410</a> real-time clock (RTC) chip with I2C interface</em></p>
<h2>Hardware</h2>
<div class="image">
<img src="in-doubler.jpg" alt="in-doubler.jpg"/>
<div class="caption">
Sample Board</div></div>
<p>This is a sample board that includes an <a class="el" href="class_m_c_p79410.html" title="Class for managing the MCP79410 real-time clock chip with SRAM and EEPROM. ">MCP79410</a> in an Adafruit FeatherWing form-factor. The documentation and Eagle CAD files for this project can be <a href="https://github.com/rickkas7/RtcFlashFeatherWingRK">found here</a>.</p>
<p>The <a class="el" href="class_m_c_p79410.html" title="Class for managing the MCP79410 real-time clock chip with SRAM and EEPROM. ">MCP79410</a> is a tiny 8-pin chip:</p>
<div class="image">
<img src="pinout.png" alt="pinout.png"/>
<div class="caption">
Pinout</div></div>
<p> With a simple application circuit:</p>
<div class="image">
<img src="typical-application.png" alt="typical-application.png"/>
<div class="caption">
Typical Application</div></div>
<p> You only need some pull-up resistors, a 32.768 kHz crystal, and a few capacitors.</p>
<p>It connects by I2C and uses addresses 0x6f (registers and SRAM) and 0x57 (EEPROM).</p>
<h2>The MFP pull-up</h2>
<p>The MFP (multi-function pin) is useful when waking up from SLEEP_MODE_DEEP based on time on Gen 3 devices (Argon, Boron, Xenon). You connect MFP to D8 for this purpose.</p>
<p>However, you must be careful: Using D8 as a wake-up pin is active high, rising. The MFP is open-collector and requires a pull-up.</p>
<p>However, in SLEEP_MODE_DEEP, an internal pull-down (about 13K) is applied to D8 so it doesn't float if not connected. Thus you must use a small-resistance pull-up or the signal won't go high enough because of the conflicting pull-up and pull-down.</p>
<p>A 2.2K pull-up works fine for this purpose.</p>
<p>Or you could use an actual inverter or transistor, if you prefer.</p>
<p>If you use a typical 10K pull-up on MFP, in wake the signal will only reach 1.9V because of the 10K pull-up and the 13K internal pull-down, and that's too low of a voltage to register as high and end sleep mode.</p>
<h2>Common Patterns</h2>
<h3>RTC Clock Synchronization</h3>
<p>By default, bi-directional clock synchronization is done.</p>
<ul>
<li>During setup() if Time is not valid but the RTC is, then Time is set from RTC. This is useful because Time is not maintained in SLEEP_MODE_DEEP.</li>
<li>During loop(), after Time is synchronized with the cloud, the RTC is updated. This only happens once at boot.</li>
</ul>
<p>You must call the setup() and loop() methods, as shown in the following example.</p>
<h3>Using RTC to wake from SLEEP_MODE_DEEP</h3>
<p>Here's a simple program to wake from SLEEP_MODE_DEEP:</p>
<div class="fragment"><div class="line">#include &quot;MCP79410RK.h&quot;</div><div class="line"></div><div class="line">SerialLogHandler logHandler;</div><div class="line"></div><div class="line">MCP79410 rtc;</div><div class="line"></div><div class="line">void setup() {</div><div class="line">    // Make sure you call rtc.setup() from setup!</div><div class="line">    rtc.setup();</div><div class="line">}</div><div class="line"></div><div class="line">void loop() {</div><div class="line">    // Make sure you call rtc.loop() from loop!</div><div class="line">    rtc.loop();</div><div class="line"></div><div class="line"></div><div class="line">    // Wait 20 seconds after boot to try sleep</div><div class="line">    if (millis() &gt; 20000) {</div><div class="line">        if (rtc.setAlarm(10)) {</div><div class="line">            Log.info(&quot;About to SLEEP_MODE_DEEP for 10 seconds&quot;);</div><div class="line">            System.sleep(SLEEP_MODE_DEEP);</div><div class="line">        }</div><div class="line">        else {</div><div class="line">            Log.info(&quot;Failed to setAlarm, not sleeping&quot;);</div><div class="line">            delay(10000);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>For Gen 2 devices, you might do something like:</p>
<div class="fragment"><div class="line">System.sleep(SLEEP_MODE_DEEP, 10);</div></div><!-- fragment --><p>but using the RTC it would be:</p>
<div class="fragment"><div class="line">if (rtc.setAlarm(10)) {</div><div class="line">    System.sleep(SLEEP_MODE_DEEP);</div><div class="line">}</div></div><!-- fragment --><p>The reason for the error check around setAlarm is that the alarm can only be set after the RTC has been set to the correct time. Upon cold boot (no 3V3, no battery) the RTC won't be set and sleep cannot be used until the first clock synchronization. This is true even when delaying by seconds.</p>
<p>You can also use rtc.isRTCValid() to determine if the RTC is believed to be correct. If isRTCValid() returns true, then setAlarm() will typically return true as well. This is handy if you want to preflight setAlarm() before turning off the network connection, for example.</p>
<h3>Using SRAM</h3>
<p>The <a class="el" href="class_m_c_p79410.html" title="Class for managing the MCP79410 real-time clock chip with SRAM and EEPROM. ">MCP79410</a> contains 64 bytes of battery-backed SRAM. This is handy if you want to store data data. This can be written to quickly and does not wear out. The data is preserved by the backup battery (CR1220 in the design above) when there is no power on 3V3.</p>
<p>The API works like the EEPROM API in Device OS:</p>
<div class="fragment"><div class="line">int a = 1234;</div><div class="line">rtc.sram().put(0, a);</div><div class="line"></div><div class="line">a = 0;</div><div class="line"></div><div class="line">rtc.sram().get(0, a);</div><div class="line"></div><div class="line">// a = 1234 again</div></div><!-- fragment --><p>The first parameter is 0, and that is a byte offset. Make sure you leave enough room! The next data should be written at 4, leaving enough room to save the 4-byte (32-bit) integer.</p>
<p>You can get and put simple data bytes (int, bool, uint32_t, etc.) and struct.</p>
<p>Note that you cannot put a String variable or char *! You need to set aside enough bytes and copy the string to the bytes.</p>
<h3>Using EEPROM</h3>
<p>The <a class="el" href="class_m_c_p79410.html" title="Class for managing the MCP79410 real-time clock chip with SRAM and EEPROM. ">MCP79410</a> contains 128 bytes of byte-writable EEPROM. This is slower to write to, but the data is preserved forever, even with no battery. The EEPROM can also wear out; it's rated for 1 million erase-write cycles for each byte.</p>
<p>The API works like the EEPROM API in Device OS:</p>
<div class="fragment"><div class="line">int a = 1234;</div><div class="line">rtc.eeprom().put(0, a);</div><div class="line"></div><div class="line">a = 0;</div><div class="line"></div><div class="line">rtc.eeprom().get(0, a);</div><div class="line"></div><div class="line">// a = 1234 again</div></div><!-- fragment --><h3>Using the Protected EEPROM Block</h3>
<p>In addition to the 128 bytes of EEPROM, there's a special block of 8 additional bytes of EEPROM. This is harder to access and accidentally erase.</p>
<p>This is often used for things like MAC addresses, however I think it would be perfect for storing board revision and capability information.</p>
<p>The 7-board-id-set example shows how to store data in the protected EEPROM.</p>
<p>The 8-board-id example shows how to read it:</p>
<div class="fragment"><div class="line">// This example shows how you&#39;d read an 8-byte structure with information about your board (that has the RTC on it)</div><div class="line">// from protected block EEPROM.</div><div class="line">//</div><div class="line">// You&#39;d run code like the 7-board-id-set example to set the values during manufacture.</div><div class="line">//</div><div class="line">// You&#39;d add code like the following to your own firmware to read the structure and presumably do something with it other</div><div class="line">// than just print it to debug serial.</div><div class="line"></div><div class="line">#include &quot;MCP79410RK.h&quot;</div><div class="line"></div><div class="line">SYSTEM_THREAD(ENABLED);</div><div class="line"></div><div class="line">SerialLogHandler logHandler;</div><div class="line">MCP79410 rtc;</div><div class="line"></div><div class="line">typedef union {</div><div class="line">    struct {</div><div class="line">        uint16_t boardType;</div><div class="line">        uint16_t boardVersion;</div><div class="line">        uint32_t featureFlags;</div><div class="line">    } data;</div><div class="line">    uint8_t bytes[MCP79410::EEPROM_PROTECTED_BLOCK_SIZE]; // 8 bytes</div><div class="line">} BoardId;</div><div class="line"></div><div class="line"></div><div class="line">void setup() {</div><div class="line">    rtc.setup();</div><div class="line"></div><div class="line">    // Wait for a USB serial connection for up to 10 seconds. This is just so you can see the Log.info</div><div class="line">    // statement, you&#39;d probably leave this out of real code</div><div class="line">    waitFor(Serial.isConnected, 10000);</div><div class="line"></div><div class="line">    // Read the BoardId structure from the protected block EEPROM</div><div class="line">    BoardId boardId;</div><div class="line">    rtc.eeprom().protectedBlockRead(boardId.bytes);</div><div class="line"></div><div class="line">    Log.info(&quot;boardType=%04x boardVersion=%04x featureFlags=%08x&quot;, boardId.data.boardType, boardId.data.boardVersion, boardId.data.featureFlags);</div><div class="line">}</div><div class="line"></div><div class="line">void loop() {</div><div class="line">    rtc.loop();</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
